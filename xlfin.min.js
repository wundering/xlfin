/**
 * xlfin.js
 * https://github.com/djhaley/xlfin
 *
 * A JavaScript library providing the capabilities of Excel's financial functions.
 *
 * @version 0.1
 * @date    2015-02-01
 *
 * @license
 * Copyright (C) 2015 Dan Haley
 *
 * xlfin.js is licensed under:
 * * The Apache 2.0 License
 *   http://www.apache.org/licenses/LICENSE-2.0
 * xlfin.js may be distributed under this license.
 *
 * Portions of this library are a recreation of the F# Excel Financial Functions
 * library located at https://github.com/fsprojects/ExcelFinancialFunctions.  The
 * F# Excel Financial Functions library is also licensed under the Apache 2.0 License.
 */
!function(){function f(a,b){var h,c=b.input,d=b.factor?parseFloat(b.factor):1,f=b.invfactor?parseFloat(b.invfactor):1,g=b.formula||"default";e.exists(a.addEventListener)&&a.addEventListener("change",function(){var b=parseFloat(a.value);b=(isNaN(b)?0:b)*d/f,e.pubsub.publish(g,[{propertyChanged:c,newValue:b}])},!1),a.disabled=!1,b.default&&(a.value=b.default,h=document.createEvent("Event"),h.initEvent("change",!0,!1),a.dispatchEvent(h))}function g(b,c){var d=c.formula||"default",f=c.pv?parseFloat(c.pv):null,g=c.rate?parseFloat(c.rate):null,h=c.nper?parseFloat(c.nper):null,i=c.pmt?parseFloat(c.pmt):null,j=c.factor?parseFloat(c.factor):1,k=c.invfactor?parseFloat(c.invfactor):1,l=function(){return"Invalid output type"};switch(c.output){case"pmt":l=function(){if(e.exists([f,h,g]))try{b.innerText=e.format(a.Pmt(g,h,-f)*j/k,2,!0)}catch(c){b.innerText="N/A"}else b.innerText="N/A"};break;case"nper":l=function(){if(e.exists([g,i,f]))try{b.innerText=e.format(a.NPer(g,i,-f)*j/k,2)}catch(c){b.innerText="N/A"}else b.innerText="N/A"};break;case"rate":l=function(){if(e.exists([h,i,f]))try{b.innerText=e.format(a.Rate(h,i,-f)*j/k,2)}catch(c){b.innerText="N/A"}else b.innerText="N/A"};break;case"pv":l=function(){if(e.exists([h,i,g]))try{b.innerText=e.format(a.Pv(g,h,i)*j/k,2)}catch(c){b.innerText="N/A"}else b.innerText="N/A"}}e.pubsub.subscribe(d,function(a){a.forEach(function(a){a.propertyChanged&&("pv"===a.propertyChanged&&(f=parseFloat(a.newValue)),"rate"===a.propertyChanged&&(g=parseFloat(a.newValue)),"nper"===a.propertyChanged&&(h=parseFloat(a.newValue)),"pmt"===a.propertyChanged&&(i=parseFloat(a.newValue)),l())})},!0)}var a,c,d,e,b=["pv","rate","nper","pmt"];c=function(){var a=d.get("[data-fin]");[].forEach.call(a,function(a){var c;c=a.getAttribute("data-fin").split(",").reduce(function(a,b){return a[b.split(":")[0].trim()]=b.split(":")[1].trim(),a},{}),c.input&&b.indexOf(c.input)>=0&&f(a,c),c.output&&b.indexOf(c.output)>=0&&g(a,c)})},d={get:function(a){return document.querySelectorAll(a)},id:function(a){return document.getElementById(a)}},e={exists:function(a){return Array.isArray(a)?a.every(function(a){return null!==a&&void 0!==a}):null!==a&&void 0!==a},format:function(a,b,c){var d=Number("1.2").toLocaleString().substr(1,1),e=c?a.toLocaleString():a,f=String(e).split(d),g=f[0],h=f.length>1?f[1]:"";return b=null===b||void 0===b?0:b,h=(h+"00").substr(0,b),g+(h.length>0?d+h:"")},pubsub:function(){var a={},b={},c=function(c,d){return b[c]||(b[c]=[]),b[c].push(d),a[c]&&a[c].forEach(function(a){a(d)}),this},d=function(c,d,e){return a[c]||(a[c]=[]),a[c].push(d),e&&b[c]&&b[c].forEach(function(a){d(a)}),this},e=function(b,c){var d=null;return a[b]&&(d=a[b].indexOf(c)),d&&a[b].splice(d,1),this};return{publish:c,subscribe:d,unsubscribe:e}}()},a=function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,a={invalidArguments:"Error in supplied arguments."},b={EndOfPeriod:0,BeginningOfPeriod:1};return c=function(a,b,c){return d(a,b,c)*k(a,b)},d=function(a,b,c){return 0===a?b:(1+a*c)*(1-p(a,b))/a},e=function(c,d,e,f,g){if(-1>c&&!w(d))throw a.invalidArguments;if(-1===c&&0>d)throw a.invalidArguments;if(0===e&&0===f)throw a.invalidArguments;return-1===c&&g===b.BeginningOfPeriod?-(f*k(c,d)):-1===c&&g===b.EndOfPeriod?-(f*k(c,d)+e):j(c,d,e,f,g)},f=function(a,b,c,d,e){return 0===a&&0!==b?-(d+c)/b:l(a,b,c,d,e)},i=function(c,e,f,g,h){if(-1>c&&!w(e))throw a.invalidArguments;if(0===g&&0===f)throw a.invalidArguments;if(-1===c&&(0===e||h===b.BeginningOfPeriod))throw a.invalidArguments;if(0===d(c,e,h))throw a.invalidArguments;return-1===c?-g:n(c,e,f,g,h)},g=function(b,c,d,e,f){if(-1>b&&!w(c))throw a.invalidArguments;if(0===d&&0===e)throw a.invalidArguments;if(-1===b)throw a.invalidArguments;return o(b,c,d,e,f)},h=function(b,c,d,f,g,h){if(0===c&&0===d||0===b)throw a.invalidArguments;if(u(c)===u(d)&&u(d)===u(f)||u(c)===u(d)&&0===f||u(c)===u(f)&&0===d||u(d)===u(f)&&0===c)throw a.invalidArguments;return 0===f&&0===d?0>c?-1:1:s(function(a){return e(a,b,c,d,g)-f},h)},j=function(a,b,d,e,f){return-(e*k(a,b)+d*c(a,b,f))},k=function(a,b){return Math.pow(1+a,b)},l=function(a,b,c,d,e){return Math.log(m(a,b,-d,e)/m(a,b,c,e))/Math.log(a+1)},m=function(a,b,c,d){return c*a+b*(1+a*d)},n=function(a,b,c,e,f){return-(c+e*p(a,b))/d(a,b,f)},o=function(a,b,c,e,f){return-(e*p(a,b)+c*d(a,b,f))},p=function(a,b){return 1/k(a,b)},q=function(a,b,c,d){var g,h,i,e=200,f=0;return i=function(b,c,g,h){var j,k;if(b===c)throw msg;if(f++,f>e)throw"Error in bisection";if(g*h>0)throw"Error in bisection";if(j=b+.5*(c-b),k=a(j),Math.abs(k)<d)return j;if(0>g*k)return i(b,j,g,k);if(g*k>0)return i(j,c,k,h);throw"Error in bisection"},g=a(b),Math.abs(g)<d?b:(h=a(c),Math.abs(h)<d?c:i(b,c,g,h))},r=function(a,b,c,d,e){var f,g,h,i,j,k,l,m;if(c>=b||b>=d)throw msg;return f=.01,g=1.6,h=60,i=function(a){return c>=a?c+e:a},j=function(a){return a>=d?d-e:a},k=function(b,c,d){var e,f;if(d-=1,0===d)throw"findBounds gave up after 60 tries";if(l=i(b),m=j(c),e=a(l),f=a(m),0>=e*f)return[l,m];if(e*f>0)return k(l+g*(l-m),m+g*(m-l),d);throw"Error in findBounds"},k(i(b-f),j(b+f),h)},s=function(a,b){var e,c=1e-7,d=t(a,b,c);return null!==d&&u(b)===u(d)?d:(e=r(a,b,-1,Number.MAX_VALUE,c),q(a,e[0],e[1],c))},t=function(a,b,c){for(var f,g,h,d=20,e=0;d>e&&(f=a(b),g=(a(b+c)-a(b-c))/(2*c),h=b-f/g,!(Math.abs(h-b)<c));)e===d-1&&(h=null),b=h,e++;return b},u=function(a){return a=+a,0===a||isNaN(a)?a:a>0?1:-1},v=function(a){return a===+a&&a!==(0|a)},w=function(a){return a===+a&&a===(0|a)},{NPer:function(a,c,d,e,g){return e=e||0,g=g||b.EndOfPeriod,f(a,c,d,e,g)},Pmt:function(a,c,d,e,f){return e=e||0,f=f||b.EndOfPeriod,i(a,c,d,e,f)},Pv:function(a,c,d,e,f){return e=e||0,f=f||b.EndOfPeriod,g(a,c,d,e,f)},Rate:function(a,c,d,e,f,g){return e=e||0,f=f||b.EndOfPeriod,g=g||.1,h(a,c,d,e,f,g)},PaymentDue:b}}(),window.xlfin||(window.xlfin=a,window.addEventListener("DOMContentLoaded",c,!1))}();